# Обработка MRS_СоздатьНоменклатуруПоEXCEL

## Описание обработки

### Назначение
Обработка предназначена для автоматизированного перехода от алкогольной номенклатуры во вскрытой таре к серийной (литражной) номенклатуре в системе учета общественного питания. Обработка обеспечивает создание новых позиций номенклатуры, обновление рецептур и управление соответствиями между старой и новой номенклатурой.

### Основные функции
- **Создание номенклатуры**: автоматическое создание серийной алкогольной номенклатуры на основе существующих позиций во вскрытой таре
- **Управление рецептурами**: создание новых рецептур с заменой вскрытых ингредиентов на серийные
- **Отслеживание соответствий**: ведение регистра соответствий между старой и новой номенклатурой  
- **Обработка исключений**: управление позициями, для которых не найдены автоматические замены
- **Создание документов сборки**: формирование документов для перевода остатков старой номенклатуры в новую

### Области применения
- Предприятия общественного питания
- Переход с учета алкоголя во вскрытой таре на серийный учет
- Модернизация системы учета номенклатуры и рецептур

---

## Пользовательская документация

### Общий порядок работы с обработкой

1. **Подготовительный этап**: создание соответствующей номенклатуры
2. **Работа с рецептурами**: создание и обновление рецептур
3. **Обработка исключений**: работа с позициями без замен
4. **Финализация**: создание сборок и завершение перехода

---

## Вкладка "Создать рецепт"

### Описание функциональности
Вспомогательная страница с таблицей рецептур в упрощенном представлении. Предназначена для быстрого просмотра и анализа списка рецептур перед переходом к детальной работе на основной вкладке.

### Основные элементы
- **Таблица рецептур**: список рецептур с основными реквизитами
  - Старая рецептура (ссылка)
  - Номер старой рецептуры
  - Коды старой номенклатуры
  - Новая рецептура (ссылка) 
  - Номер новой рецептуры
  - Коды новой номенклатуры
  - Подразделение
  - Статус рецептуры
  - Строка ошибок (при наличии)

### Назначение
Эта вкладка служит промежуточным этапом для:
- Получения общего представления о количестве рецептур к обработке
- Быстрой оценки статусов обработки
- Перехода к детальной работе с составом рецептур

> **Рекомендация**: После ознакомления с данными на этой вкладке переходите к работе на вкладке "Редактировать состав рецептур" для детального управления процессом.

---

## Вкладка "Редактировать состав рецептур"

### Описание интерфейса

Основная рабочая область обработки содержит:
- **Дерево рецептур**: иерархическое представление старых и новых рецептур с их ингредиентами
- **Панель управления**: кнопки для выполнения основных операций
- **Фильтры отображения**: настройки для показа определенных категорий рецептур

### Структура интерфейса

Обработка имеет четыре основные вкладки:
1. **"Создать рецепт"** - исходная страница с таблицей рецептур
2. **"Редактировать состав рецептур"** - основная рабочая область с деревом рецептур *(основная вкладка)*
3. **"Позиции без замен"** - управление проблемными позициями *(рассмотрена отдельно)*
4. **"Создать сборки"** - создание документов сборки для перевода остатков

### Основные элементы управления

#### Кнопки управления:
- **"Предзаполнить связи"** (`ОбновитьПредзаполнение`): автоматический поиск связей между старыми и новыми рецептурами по дополнительным реквизитам
- **"Получить рецептуры"** (`ПолучитьРецептуры`): загрузка рецептур, содержащих алкогольную продукцию во вскрытой таре
- **"Создать номенклатуру"** (`СоздатьНоменклатуру`): создание новых позиций серийной номенклатуры
- **"Сохранить изменения в рецептурах"** (`СохранитьИзмененияВРецептурах`): применение внесенных изменений соответствий
- **"Обновить рецептуры по связям"** (`ОбновитьРецептурыПоСвязям`): обновление существующих рецептур на основе найденных соответствий
- **"Обновить дерево рецептур"** (`ОбновитьДеревоРецептур`): обновление отображения дерева после изменений
- **"Создать сборки"** (`Создатьсборки`): создание документов сборки для конвертации остатков

#### Фильтры:
- **"Только без соответствий"**: показывать только рецептуры с неполными заменами
- **"Только не созданные"**: показывать только рецептуры, для которых не созданы новые версии
- **"Только частично замененные"**: показывать рецептуры с частичными заменами ингредиентов

### Пошаговая инструкция по работе

#### Шаг 1: Создание номенклатуры
1. Нажмите кнопку **"Создать номенклатуру"**
2. Система автоматически найдет всю алкогольную номенклатуру во вскрытой таре
3. Для каждой найденной позиции будет создана соответствующая серийная номенклатура с суффиксом `[mrs]`
4. Автоматически создадутся упаковки и настройки для интеграции с информационными системами
5. Дождитесь завершения процесса (отображается прогресс по пакетам)

#### Шаг 2: Получение рецептур для обработки
1. Нажмите кнопку **"Получить рецептуры"**
2. Система найдет все активные рецептуры, содержащие алкогольные ингредиенты во вскрытой таре
3. Для каждой найденной рецептуры будет создана новая версия с заменой ингредиентов
4. Результаты отобразятся в дереве рецептур

#### Шаг 3: Работа с деревом рецептур
**Структура дерева:**
- **СТАРАЯ**: оригинальная рецептура с ингредиентами во вскрытой таре
  - Ингредиенты помечаются статусами: "Есть соответствие", "Нет соответствия", "Не алкоголь"
- **НОВАЯ**: созданная рецептура с заменами на серийную номенклатуру
  - Ингредиенты помечаются статусами: "Заменён", "Новый", "Не алкоголь"

**Ручное редактирование соответствий:**
1. В дереве найдите ингредиент со статусом "Нет соответствия"
2. В колонке "Новая номенклатура" выберите подходящую серийную позицию
3. Статус автоматически изменится на "Есть соответствие"
4. После внесения всех изменений нажмите **"Сохранить изменения в рецептурах"**

#### Шаг 4: Использование фильтров
- Установите флажок **"Только без соответствий"** для отображения только проблемных рецептур
- Используйте **"Только не созданные"** для работы с рецептурами, требующими создания новых версий
- **"Только частично замененные"** поможет найти рецептуры с неполными заменами

#### Шаг 5: Обновление существующих рецептур
1. Нажмите кнопку **"Обновить рецептуры по связям"**
2. Система обновит все рецептуры, для которых найдены соответствия ингредиентов
3. Процесс обновляет как новые, так и частично обработанные рецептуры

### Статусы рецептур
- **"Полностью заменена"**: все алкогольные ингредиенты имеют соответствия
- **"Частично заменена"**: часть ингредиентов заменена, но есть позиции без соответствий
- **"Не заменена"**: ни один ингредиент не имеет соответствия
- **"Не создана"**: новая версия рецептуры еще не создана
- **"Нет алкоголя"**: рецептура не содержит алкогольных ингредиентов

---

## Вкладка "Позиции без замен"

### Описание функциональности
Страница предназначена для работы с алкогольными позициями, для которых система не смогла автоматически найти соответствия в серийной номенклатуре.

### Элементы интерфейса
- **Дерево позиций**: иерархическое представление проблемных позиций
  - Верхний уровень: уникальные позиции номенклатуры без замен
  - Вложенный уровень: рецептуры, использующие эти позиции
- **Кнопки управления**: 
  - **"Показать позиции без замен"**: обновление списка проблемных позиций
  - **"Сохранить замены"**: применение указанных пользователем соответствий

### Пошаговая работа с позициями без замен

#### Шаг 1: Получение списка позиций
1. Перейдите на вкладку **"Позиции без замен"**
2. Нажмите кнопку **"Показать позиции без замен"**
3. Система найдет все алкогольные позиции во вскрытой таре, для которых нет соответствий в регистре замен
4. Результат отобразится в виде дерева с группировкой по номенклатуре

#### Шаг 2: Анализ проблемных позиций
**Структура отображения:**
- **Родительский узел**: проблемная номенклатура (отображается наименование и код)
- **Дочерние узлы**: рецептуры, которые используют эту номенклатуру

**Информация в строках:**
- Наименование и код номенклатуры
- Список рецептур, где используется позиция
- Поле для указания замены

#### Шаг 3: Указание замен
1. Для каждой проблемной позиции в поле **"Замена"** выберите соответствующую серийную номенклатуру
2. При указании замены для одной позиции система автоматически применит её ко всем строкам с той же номенклатурой
3. Можно указать замены выборочно - система дополнит остальные автоматически

#### Шаг 4: Сохранение результатов
1. После указания всех необходимых замен нажмите **"Сохранить замены"**
2. Система запишет соответствия в регистр `MRS_СоответствиеСтаройНовойНоменклатуры`
3. Обновится список позиций (обработанные позиции исчезнут из списка)

### Рекомендации по работе с заменами

#### Принципы выбора замен:
1. **Соответствие объема**: выбирайте серийную номенклатуру с аналогичным объемом
2. **Соответствие типа продукции**: водка заменяется на водку, коньяк на коньяк и т.д.
3. **Соответствие крепости**: учитывайте процент содержания алкоголя

#### Типичные случаи замен:
- `Водка "Бренд" вскрытая 0.5л` → `Водка "Бренд" 0.5л [mrs]`
- `Коньяк "Марка" вскрытый 0.7л` → `Коньяк "Марка" 0.7л [mrs]`
- `Вино "Название" вскрытое 0.75л` → `Вино "Название" 0.75л [mrs]`

---

## Вкладка "Создать сборки"

### Описание функциональности
Страница предназначена для создания документов сборки, которые позволяют перевести остатки номенклатуры из старого формата (во вскрытой таре) в новый (серийная номенклатура).

### Основные элементы
- **Поле "Номенклатура"**: выбор конкретной позиции номенклатуры для обработки
- **Поле "Склад"**: указание склада для создания документов сборки  
- **Поле "Период"**: дата, на которую определяются остатки номенклатуры
- **Кнопка "Создать сборки"**: запуск процесса создания документов
- **Таблица "Документы сборки"**: список созданных документов

### Порядок работы
1. **Выбор номенклатуры**: укажите позицию старой (вскрытой) номенклатуры для конвертации
2. **Настройка параметров**: выберите склад и период для анализа остатков
3. **Создание сборок**: нажмите кнопку "Создать сборки"
4. **Контроль результатов**: проверьте созданные документы в таблице

### Особенности процесса
- Автоматически находит соответствующую новую номенклатуру через дополнительные реквизиты
- Создает документы сборки только для позиций с остатками на указанную дату
- Формирует правильные серии и упаковки для новой номенклатуры
- Обновляет настройки интеграции с фронт-системами

---

## Дополнительные возможности

### Интеграция с фронт-системами
Обработка автоматически обновляет настройки соответствий для интеграции с внешними системами (например, Micros).

### Работа с упаковками
Автоматически создаются упаковки для новой номенклатуры с правильными коэффициентами пересчета.

---

## Техническая информация

### Используемые регистры сведений:
- `MRS_СоответствиеСтаройНовойНоменклатуры` - хранение соответствий между старой и новой номенклатурой
- `ПЛ_СоответствиеСФронтСистемами` - настройки интеграции с внешними системами
- `ОписаниеНоменклатурыИС` - настройки для информационных систем

### Дополнительные реквизиты:
- `MRS_НоваяРецептура` - связь между старой и новой рецептурой
- `MRS_НоменклатураНовая` - указание соответствующей новой номенклатуры

### Особенности обработки:
- Пакетная обработка для избежания блокировок базы данных
- Транзакционная безопасность операций
- Подробное логирование процесса выполнения
- Возможность восстановления после ошибок

---

## Возможные проблемы и их решения

### Ошибки при создании номенклатуры
**Проблема**: Ошибка "дублирование наименования"
**Решение**: Проверьте, не создавалась ли уже такая номенклатура ранее

### Рецептуры не создаются
**Проблема**: Отсутствуют соответствия в регистре
**Решение**: Выполните создание номенклатуры, затем укажите недостающие замены через вкладку "Позиции без замен"

### Большое количество позиций без замен
**Проблема**: Много позиций требуют ручной обработки
**Решение**: Используйте принцип группировки - указав замену для одной позиции, она применится ко всем одноименным

---

*Документация создана для обработки MRS_СоздатьНоменклатуруПоEXCEL*
*Версия: 1.0*
*Дата: 2025*
