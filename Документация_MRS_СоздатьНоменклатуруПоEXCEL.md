# Обработка "Замена алкогольных рецептур"

## Описание обработки

### Назначение
Обработка предназначена для автоматизированного перехода от алкогольной номенклатуры во вскрытой таре к серийной (литражной) номенклатуре в системе учета общественного питания. Обработка обеспечивает создание новых позиций номенклатуры, обновление рецептур и управление соответствиями между старой и новой номенклатурой.

### Основные функции
- **Создание номенклатуры**: автоматическое создание серийной алкогольной номенклатуры на основе существующих позиций во вскрытой таре
- **Управление рецептурами**: создание новых рецептур с заменой вскрытых ингредиентов на серийные
- **Отслеживание соответствий**: ведение регистра соответствий между старой и новой номенклатурой  
- **Обработка исключений**: управление позициями, для которых не найдены автоматические замены
- **Создание документов сборки**: формирование документов для перевода остатков старой номенклатуры в новую

### Области применения
- Переход с учета алкоголя во вскрытой таре на серийный учет
- Модернизация системы учета номенклатуры и рецептур

---

## Пользовательская документация

### Общий порядок работы с обработкой

1. **Подготовительный этап**: создание соответствующей номенклатуры (выполнено)
2. **Работа с рецептурами**: создание и обновление рецептур (предварительно выполнена)
3. **Обработка исключений**: работа с позициями без замен
4. **Финализация**: создание сборок и завершение перехода

---

## Вкладка "Редактировать состав рецептур"

### Описание интерфейса

Основная рабочая область обработки содержит:
- **Дерево рецептур**: иерархическое представление старых и новых рецептур с их ингредиентами
- **Панель управления**: кнопки для выполнения основных операций
- **Фильтры отображения**: настройки для показа определенных категорий рецептур

### Структура интерфейса

Обработка имеет четыре основные вкладки:
1. **"Создать рецепт"** - исходная страница с таблицей рецептур
2. **"Редактировать состав рецептур"** - основная рабочая область с деревом рецептур *(основная вкладка)*
3. **"Позиции без замен"** - управление проблемными позициями *(рассмотрена отдельно)*
4. **"Создать сборки"** - создание документов сборки для перевода остатков

### Основные элементы управления

#### Кнопки управления:
- **"Предзаполнить связи"** (`ОбновитьПредзаполнение`): автоматический поиск связей между старыми и новыми рецептурами по дополнительным реквизитам
- **"Получить рецептуры"** (`ПолучитьРецептуры`): загрузка рецептур, содержащих алкогольную продукцию во вскрытой таре
- **"Сохранить изменения в рецептурах"** (`СохранитьИзмененияВРецептурах`): применение внесенных изменений соответствий
- **"Обновить рецептуры по связям"** (`ОбновитьРецептурыПоСвязям`): обновление существующих рецептур на основе найденных соответствий
- **"Обновить дерево рецептур"** (`ОбновитьДеревоРецептур`): обновление отображения дерева после изменений
- **"Отключить выбранные рецептуры"** (`ОтключитьВыбранныеРецептуры`): установка даты окончания для выбранных в дереве рецептур

#### Фильтры:
- **"Только без соответствий"**: показывать только рецептуры с неполными заменами
- **"Только не созданные"**: показывать только рецептуры, для которых не созданы новые версии
- **"Только частично замененные"**: показывать рецептуры с частичными заменами ингредиентов

### Пошаговая инструкция по работе

#### Альтернативный старт: Предзаполнение связей
**Если у вас уже есть созданные рецептуры с указанными связями:**
1. Нажмите кнопку **"Предзаполнить связи"**
2. **Система найдет существующие связи**:
   - Ищет рецептуры с дополнительным реквизитом `MRS_НоваяРецептура`
   - По номеру из этого реквизита находит соответствующую новую рецептуру
   - Заполняет таблицу связей между старыми и новыми рецептурами
   - Анализирует ингредиенты обеих рецептур
3. Результаты отобразятся в дереве рецептур
4. **Переходите к шагу 3** (работа с деревом рецептур)

#### Шаг 1: Создание номенклатуры
1. Нажмите кнопку **"Создать номенклатуру"**
2. **Система автоматически найдет** всю алкогольную номенклатуру во вскрытой таре, исключая:
   - Номенклатуру с видами "Готовая алкогольная продукция с ФСМ"
   - Пивную продукцию
   - Позиции с пометкой "не использовать" в названии
3. **Логика обработки зависит от наличия остатков у исходной серийной номенклатуры:**
   - **Если ЕСТЬ остатки**:
       - Создается **новая** серийная номенклатура с суффиксом `[mrs]` и указанием объема в литрах (например, "0,5л").
       - Для новой номенклатуры создается упаковка в штуках с коэффициентом пересчета (объем в ДАЛ × 10).
       - Настраивается единица для отчетов и создается запись в регистре `ОписаниеНоменклатурыИС`.
       - В регистр `MRS_СоответствиеСтаройНовойНоменклатуры` записывается связь между старой, вскрытой и новой `[mrs]` номенклатурой.
   - **Если НЕТ остатков**:
       - Новая номенклатура **не создается**.
       - Для **существующей** серийной номенклатуры изменяется `ЕдиницаХраненияОстатков` на "л" (литры).
       - Для нее создается новая упаковка в штуках и запись в `ОписаниеНоменклатурыИС`.
4. **Автоматическая коррекция наименований**: для вновь создаваемой номенклатуры с суффиксом `[mrs]` выполняется добавление объема в стандартизированном формате.
5. Дождитесь завершения процесса (отображается прогресс по пакетам)

#### Шаг 2: Получение рецептур для обработки
1. Нажмите кнопку **"Получить рецептуры"**
2. **Система найдет** все активные рецептуры со следующими критериями:
   - Содержат алкогольные ингредиенты во вскрытой таре
   - Не помечены на удаление
   - Не содержат в названии суффикс "_mrs"
   - Не относятся к номенклатуре со свободной ценой
3. **Для каждой найденной рецептуры**:
   - Создается копия с изменением периода действия
   - Устанавливаются новые даты: начало - завтра, конец - не ограничен
   - Добавляется комментарий "Создан обработкой для перевода в серийный алкоголь"
   - Заменяются ингредиенты на серийные (при наличии соответствий)
   - Устанавливается связь со старой рецептурой через дополнительный реквизит `MRS_НоваяРецептура`
   - Старая рецептура завершается текущей датой
4. Результаты отобразятся в дереве рецептур с указанием статусов обработки

#### Шаг 3: Работа с деревом рецептур
**Структура дерева:**
- **СТАРАЯ**: оригинальная рецептура с ингредиентами во вскрытой таре
  - Ингредиенты помечаются статусами: "Есть соответствие", "Нет соответствия", "Не алкоголь"
- **НОВАЯ**: созданная рецептура с заменами на серийную номенклатуру
  - Ингредиенты помечаются статусами: "Заменён", "Новый", "Не алкоголь"

**Ручное редактирование соответствий:**
1. В дереве найдите ингредиент со статусом "Нет соответствия"
2. В колонке "Новая номенклатура" выберите подходящую серийную позицию
3. Статус автоматически изменится на "Есть соответствие"
4. После внесения всех изменений нажмите **"Сохранить изменения в рецептурах"**

#### Шаг 4: Использование фильтров
- Установите флажок **"Только без соответствий"** для отображения только проблемных рецептур
- Используйте **"Только не созданные"** для работы с рецептурами, требующими создания новых версий
- **"Только частично замененные"** поможет найти рецептуры с неполными заменами

#### Шаг 5: Обновление существующих рецептур
1. Нажмите кнопку **"Обновить рецептуры по связям"**
2. Система обновит все рецептуры, для которых найдены соответствия ингредиентов
3. Процесс обновляет как новые, так и частично обработанные рецептуры

#### Шаг 6: Отключение ненужных рецептур
1. В дереве рецептур установите флажок **"Отключить"** напротив тех старых или новых рецептур, которые больше не должны использоваться.
2. Нажмите кнопку **"Отключить выбранные рецептуры"**.
3. **Система установит `ДатуКонца`** для каждой отмеченной рецептуры, делая ее неактивной.
4. Для каждой **старой** рецептуры (наименование не содержит `_mrs`) будет создана запись в регистре `MRS_НеАктуальныеРецептуры` для аудита.
5. Список рецептур в обработке обновится, исключая отключенные позиции.

### Статусы рецептур
- **"Полностью заменена"**: все алкогольные ингредиенты имеют соответствия
- **"Частично заменена"**: часть ингредиентов заменена, но есть позиции без соответствий
- **"Не заменена"**: ни один ингредиент не имеет соответствия
- **"Не создана"**: новая версия рецептуры еще не создана
- **"Нет алкоголя"**: рецептура не содержит алкогольных ингредиентов

---

## Вкладка "Позиции без замен"

### Описание функциональности
Страница предназначена для работы с алкогольными позициями, для которых система не смогла автоматически найти соответствия в серийной номенклатуре.

### Элементы интерфейса
- **Дерево позиций**: иерархическое представление проблемных позиций
  - Верхний уровень: уникальные позиции номенклатуры без замен
  - Вложенный уровень: рецептуры, использующие эти позиции
- **Колонки таблицы**:
  - **"Номенклатура"**: исходная позиция без замены
  - **"Рецептура"**: рецептуры, где используется позиция  
  - **"Ручная замена"**: замена, указанная пользователем вручную
  - **"Авто замена"**: автоматически найденный вариант замены
  - **"Отключить"**: флажок для выбора рецептур к отключению
- **Кнопки управления**: 
  - **"Показать позиции без замен"**: обновление списка проблемных позиций
  - **"Сохранить замены"**: применение указанных пользователем соответствий
  - **"Отключить неактуальные рецептуры"**: установка даты окончания для выбранных рецептур

### Пошаговая работа с позициями без замен

#### Шаг 1: Получение списка позиций
1. Перейдите на вкладку **"Позиции без замен"**
2. Нажмите кнопку **"Показать позиции без замен"**
3. Система найдет все алкогольные позиции во вскрытой таре, для которых нет соответствий в регистре замен
4. Результат отобразится в виде дерева с группировкой по номенклатуре

#### Шаг 2: Анализ проблемных позиций
**Структура отображения:**
- **Родительский узел**: проблемная номенклатура (отображается наименование и код)
- **Дочерние узлы**: рецептуры, которые используют эту номенклатуру

**Информация в строках:**
- Наименование и код номенклатуры
- Список рецептур, где используется позиция
- Поле для указания замены

#### Шаг 3: Работа с автоматическими заменами
1. **Система автоматически анализирует** каждую проблемную позицию:
   - Ищет серийную номенклатуру с реквизитом `ПЛ_НоменклатураВоВскрытойТаре`, указывающим на исходную позицию
   - Если найден **единственный вариант** - автоматически подставляет его в колонку "Авто замена"
   - Если найдено **несколько вариантов** - оставляет поле пустым для ручного выбора

2. **Работа с полем "Авто замена"**:
   - При **клике** на поле с несколькими вариантами откроется диалог выбора
   - Если найден только один вариант - подставляется автоматически
   - При отсутствии вариантов выводится предупреждение

#### Шаг 4: Указание ручных замен
1. В поле **"Ручная замена"** можно вручную выбрать любую подходящую номенклатуру
2. **Приоритет замен**: ручная замена имеет приоритет над автоматической
3. При указании замены для одной позиции система автоматически применит её ко всем строкам с той же номенклатурой

#### Шаг 5: Сохранение результатов
1. После указания всех необходимых замен нажмите **"Сохранить замены"**
2. **Система обработает замены в следующем порядке**:
   - Сначала собирает все ручные замены
   - Применяет их ко всем строкам с аналогичной номенклатурой
   - Для незаполненных строк использует автоматические замены
   - Записывает соответствия в регистр `MRS_СоответствиеСтаройНовойНоменклатуры`
3. Автоматически обновится список позиций (обработанные позиции исчезнут из списка)
4. Выводится сводка: "Создано: X, обновлено: Y"

#### Шаг 6: Отключение неактуальных рецептур
1. На вкладке "Позиции без замен" вы можете массово отключать рецептуры, которые больше не актуальны.
2. Установите флажок **"Отключить"** напротив нужных позиций.
   - Если установить флажок на уровне **номенклатуры** (верхний уровень), он автоматически проставится для **всех** вложенных рецептур.
   - Можно выбирать и отдельные рецептуры.
3. Нажмите кнопку **"Отключить неактуальные рецептуры"**.
4. **Система установит `ДатуКонца`** для всех выбранных рецептур.
5. Для каждой отключенной **старой** рецептуры будет создана запись в регистре аудита `MRS_НеАктуальныеРецептуры`.
6. Список позиций на вкладке будет обновлен.

### Рекомендации по работе с заменами

#### Принципы выбора замен:
1. **Соответствие объема**: выбирайте серийную номенклатуру с аналогичным объемом
2. **Соответствие типа продукции**: водка заменяется на водку, коньяк на коньяк и т.д.
3. **Соответствие крепости**: учитывайте процент содержания алкоголя

#### Типичные случаи замен:
- `Водка "Бренд" вскрытая 0.5л` → `Водка "Бренд" 0.5л [mrs]`
- `Коньяк "Марка" вскрытый 0.7л` → `Коньяк "Марка" 0.7л [mrs]`
- `Вино "Название" вскрытое 0.75л` → `Вино "Название" 0.75л [mrs]`

---

## Дополнительные возможности

### Интеграция с фронт-системами
Обработка автоматически обновляет настройки соответствий для интеграции с внешними системами (например, Micros).

### Работа с упаковками
Автоматически создаются упаковки для новой номенклатуры с правильными коэффициентами пересчета.

---

## Техническая информация

### Используемые регистры сведений:
- `MRS_СоответствиеСтаройНовойНоменклатуры` - хранение соответствий между старой и новой номенклатурой
- `ПЛ_СоответствиеСФронтСистемами` - настройки интеграции с внешними системами
- `MRS_НеАктуальныеРецептуры` - хранение истории отключения старых рецептур для аудита

### Дополнительные реквизиты:
- `MRS_НоваяРецептура` - связь между старой и новой рецептурой
- `MRS_НоменклатураНовая` - указание соответствующей новой номенклатуры

---

## Возможные проблемы и их решения

#### Ошибки при создании номенклатуры
**Проблема**: Ошибка "дублирование наименования"
**Решение**: Проверьте, не создавалась ли уже такая номенклатура ранее. Система пропускает уже существующие позиции автоматически.

**Проблема**: Ошибки транзакций при пакетной обработке
**Решение**: Система использует пакеты по 10 элементов. При ошибке в пакете все изменения откатываются, обработка продолжается со следующего пакета.

#### Проблемы с рецептурами
**Проблема**: Рецептуры не создаются
**Решение**: Выполните создание номенклатуры, затем укажите недостающие замены через вкладку "Позиции без замен"

**Проблема**: Статус "Частично заменена" у многих рецептур
**Решение**: Используйте фильтр "Только частично замененные" и доработайте соответствия вручную

**Проблема**: Ошибки записи новых рецептур
**Решение**: Проверьте права доступа и корректность заполнения обязательных полей исходных рецептур

#### Работа с позициями без замен
**Проблема**: Большое количество позиций без замен
**Решение**: Используйте принцип группировки - указав замену для одной позиции, она применится ко всем одноименным

**Проблема**: Нет подходящих вариантов автозамены
**Решение**: Создайте недостающую серийную номенклатуру вручную или используйте ручную замену на существующую

#### Технические проблемы
**Проблема**: Медленная работа обработки
**Решение**: Система использует пакетную обработку и оптимизированные запросы. При очень больших объемах рассмотрите фильтрацию по подразделениям или периодам

---

*Документация создана для обработки "Замена алкогольных рецептур"*
*Версия: 1.0*
*Дата: 2025*
