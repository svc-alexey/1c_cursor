## Title
Product Requirements Document (PRD): Отключение неактуальных рецептур в обработке "Замены Алко Рецептур"

## Контекст и цели

### Проблема и предпосылки
В настоящее время в обработке "MRS_ЗаменыАлкоРецептур" отсутствует удобный механизм для деактивации старых или неиспользуемых алкогольных рецептур. Пользователям приходится вручную находить рецептуры и устанавливать для них "Дату конца", что трудоемко и может приводить к ошибкам. Отсутствие централизованного инструмента усложняет управление жизненным циклом рецептур и создает риск использования устаревших данных.

### Цели
- **Предоставить интерфейс** для быстрой и массовой деактивации рецептур непосредственно из формы обработки "MRS_ЗаменыАлкоРецептур".
- **Автоматизировать процесс** установки реквизита `ДатаКонца` для выбранных рецептур.
- **Обеспечить аудит действий** пользователей путем логирования всех операций по деактивации в специализированный регистр сведений.
- **Снизить трудозатраты** и минимизировать ошибки при работе с большим количеством рецептур.

### Вне рамок проекта (Non-goals)
- Данная доработка не предполагает физического удаления документов рецептур.
- Система не будет автоматически предлагать рецептуры для деактивации; выбор всегда остается за пользователем.
- Не будет реализован механизм отмены действия по деактивации рецептуры.

## Предположения
- Все изменения реализуются в рамках существующей обработки `MRS_ЗаменыАлкоРецептур`.
- Пользователь, выполняющий операцию, обладает необходимыми правами для изменения документов `питРецептура`.
- Новый регистр сведений будет использоваться для контроля и отчетности по действиям пользователей.

## Основные функции
- **Логирование действий**: Создание и запись в новый регистр сведений информации о том, кто, когда и какую рецептуру деактивировал.
- **Выборочная деактивация на вкладке "Редактировать состав"**: Возможность для пользователя выбрать конкретные старые и новые рецептуры для установки даты окончания.
- **Массовая деактивация на вкладке "Позиции без замен"**: Возможность выбрать как отдельные рецептуры, так и все рецептуры для конкретной номенклатуры для последующей деактивации.
- **Обработка выбора**: Реализация серверной логики, которая по нажатию кнопки обрабатывает выбранные пользователем позиции, устанавливает им `ДатаКонца` и создает записи в регистре.
- **Фильтрация неактуальных рецептур**: При заполнении списков рецептур в обработке необходимо исключать те, что присутствуют в регистре сведений `MRS_НеАктуальныеРецептуры`.

## Пользовательские сценарии (Flows)

### Сценарий 1: Отключение рецептур на вкладке "Редактировать состав рецептуры"
1.  Пользователь открывает обработку `MRS_ЗаменыАлкоРецептур` и переходит на вкладку "Редактировать состав рецептуры".
2.  В дереве рецептур отображается новая колонка с чекбоксами `Отключить` напротив каждой строки (старой и новой рецептуры).
3.  Пользователь устанавливает флажки напротив тех рецептур, которые необходимо сделать неактуальными.
4.  Пользователь нажимает новую кнопку **"Отключить выбранные рецептуры"**.
5.  Система обрабатывает каждую отмеченную рецептуру (как старую, так и новую). Если у рецептуры не была установлена `ДатаКонца` (т.е. она активна), система устанавливает ее равной текущей дате.
6.  Для каждой отключенной **старой** рецептуры (имя которой не содержит `_mrs`) создается запись в регистре сведений `MRS_НеАктуальныеРецептуры`.
7.  Пользователь получает сообщение об успешном завершении операции с указанием количества обработанных рецептур.

### Сценарий 2: Отключение рецептур на вкладке "Позиции без замен"
1.  Пользователь переходит на вкладку "Позиции без замен".
2.  В дереве номенклатуры и рецептур появляется новая колонка с чекбоксами `Отключить`. Флажки доступны как для строк с номенклатурой (верхний уровень), так и для строк с конкретными рецептурами (вложенный уровень).
3.  Пользователь отмечает необходимые позиции. Установка флажка на номенклатуре автоматически отмечает все вложенные рецептуры.
4.  Пользователь нажимает новую кнопку **"Отключить неактуальные рецептуры"**.
5.  Система на сервере обрабатывает все отмеченные рецептуры:
    *   Для каждой выбранной рецептуры, у которой не была установлена `ДатаКонца`, система устанавливает ее равной текущей дате.
6.  Для каждой затронутой **старой** рецептуры (имя которой не содержит `_mrs`) создается запись в регистре `MRS_НеАктуальныеРецептуры`.
7.  Пользователь получает сообщение о результатах выполнения, и список на вкладке обновляется.

## Данные и интеграции

### Новый объект: Регистр сведений "MRS_НеАктуальныеРецептуры"
- **Назначение**: Хранение истории деактивации рецептур для аудита и анализа.
- **Структура**:

| Тип поля | Имя поля | Тип данных | Описание |
| :--- | :--- | :--- | :--- |
| **Измерение** | `Пользователь` | `СправочникСсылка.Пользователи` | Пользователь, выполнивший операцию. |
| **Измерение** | `Рецептура` | `ДокументСсылка.питРецептура` | Рецептура, для которой установлена дата окончания. |
| **Ресурс** | `ДатаВремяДействия` | `Дата` | Точное время выполнения операции. |

## Метаданные: Объекты конфигурации

### Новые объекты
1.  **Регистр сведений**: `MRS_НеАктуальныеРецептуры` (структура описана выше).

### Модифицируемые объекты
1.  **Обработка**: `MRS_ЗаменыАлкоРецептур`
    *   **Форма.Форма**:
        *   На вкладке "Редактировать состав рецептуры":
            *   Добавить в дерево `ДеревоРецептур` новый реквизит `Отключить` (тип `Булево`) и вывести его как колонку с чекбоксом.
            *   Добавить в командную панель кнопку `ОтключитьВыбранныеРецептуры`.
        *   На вкладке "Позиции без замен":
            *   Добавить в дерево `ДеревоПозицийБезЗамен` новый реквизит `Отключить` (тип `Булево`) и вывести его как колонку с чекбоксом.
            *   Добавить в командную панель кнопку `ОтключитьНеактуальныеРецептуры`.
    *   **Модуль Формы**:
        *   Реализовать клиентские обработчики для новых кнопок.
        *   Реализовать серверные процедуры для обработки выбранных рецептур, установки `ДатаКонца` и записи данных в регистр `MRS_НеАктуальныеРецептуры`.
        *   Доработать процедуры `ПредзаполнитьСвязиРецептурНаСервере` и `ПоказатьПозицииБезЗаменНаСервере` для исключения рецептур, имеющихся в регистре `MRS_НеАктуальныеРецептуры`.
