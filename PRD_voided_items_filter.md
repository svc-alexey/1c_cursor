## Title
Корректировка SQL-запроса для исключения сторнированных позиций чека

## Context & Goals

### Problem & background
Текущий SQL-скрипт `Script-2.sql` выгружает детализацию по чекам из базы данных Oracle. В выгрузку попадают все операции по позициям, включая как продажи (положительное количество), так и их отмены/сторно (отрицательное количество). Это приводит к тому, что в итоговом отчете присутствуют лишние строки и некорректно рассчитываются итоговые суммы, так как аннулированные товары не отфильтрованы. Кроме того, полностью отфильтровываются чеки возврата, в которых все позиции имеют отрицательное количество, что является некорректным поведением.

### Objectives
- Модифицировать SQL-запрос для корректной идентификации и исключения сторнированных позиций и соответствующих им продаж в чеках продажи.
- Итоговая выгрузка должна содержать только те товарные позиции, которые были фактически проданы и не отменены.
- Обеспечить корректную загрузку чеков возврата, в которых все позиции являются отрицательными.
- Для оставшихся в отчете позиций необходимо сохранить их оригинальный номер в чеке (`detailindex`).

### Non-goals / Out of scope
- Изменение структуры итоговых колонок отчета.
- Оптимизация производительности других частей запроса, не связанных с логикой фильтрации сторно.
- Создание новых таблиц или представлений в базе данных.

## Core functions
- Система должна идентифицировать тип чека: "чек продажи" (содержит хотя бы одну положительную позицию) или "чек возврата" (все позиции отрицательные).
- Для **чеков возврата** все строки должны быть включены в итоговую выгрузку без изменений.
- Для **чеков продажи** применяется следующая логика:
    - Для каждого товара (`objectnumber`) внутри чека должен быть рассчитан итоговый суммарный объем (`quantity`).
    - Если итоговый объем по товару равен нулю (например, продана 1 штука и отменена 1 штука), все строки по этому товару для данного чека должны быть исключены из выборки.
    - Если итоговый объем по товару больше нуля (частичная отмена, например, продано 3, отменена 1), в отчете должны остаться строки продаж в количестве, равном итоговому объему (в примере — 2 строки).

## Flows (Text-Only)
1.  Для каждого чека (`checkid`) определяется его тип на основе позиций в `transdb.check_detail`:
    - **Чек возврата**: если все строки для данного `checkid` имеют отрицательное значение `quantity`.
    - **Чек продажи**: если в чеке присутствует хотя бы одна строка с положительным `quantity`.
2.  На основе этого определения вводится поле `check_type` (`-1` для возврата, `1` для продажи).
3.  Если чек определен как **чек возврата** (`check_type = -1`), все его строки включаются в итоговую выборку без дополнительной фильтрации.
4.  Если чек определен как **чек продажи** (`check_type = 1`), к нему применяется следующая логика фильтрации:
    - В рамках чека (`checkid`) вычисляется итоговое количество по каждому коду товара (`objectnumber`), суммируя значения из поля `quantity`.
    - На основе этих расчетов формируется список товаров с "чистыми" продажами, где итоговое количество больше нуля.
    - Далее происходит фильтрация исходного набора данных:
        - Полностью удаляются строки по товарам, где итоговое количество равно нулю.
        - Для товаров с частичной отменой (итоговое количество > 0), из выборки удаляются все строки отмен (с отрицательным `quantity`) и соответствующее им количество строк продаж.
5.  **Правило выбора сохраняемых строк**: При частичной отмене в чеке продажи должны сохраняться самые ранние по порядку (`detailindex`) строки продаж. Например, если было продано 3 единицы товара (со строками 10, 15, 20) и отменена 1 единица, в итоговом отчете должны остаться строки с `detailindex` 10 и 15.
6.  Отфильтрованный набор данных передается дальше для финального формирования отчета.

## Data & Integrations
- **Core entities**: `transdb.check_detail`, `transdb.checks`.
- **Important fields**:
    - `check_detail.checkid`: Идентификатор чека.
    - `check_detail.objectnumber`: Идентификатор (код) товара.
    - `check_detail.detailindex`: Порядковый номер позиции в чеке.
    - `check_detail.numerator` / `check_detail.denominator`: Поля для расчета количества (`quantity`). Отрицательное значение `quantity` или `total` означает отмену.

## Metadata
- **Затрагиваемые объекты 1С**: Данный документ описывает требования к SQL-запросу. Он не затрагивает напрямую конфигурационные объекты 1С, но влияет на качество данных, подготавливаемых для загрузки в 1С.
- **Затрагиваемый код**: Логика фильтрации реализована в рамках CTE `RankedPreChecksDetail` и `FilteredPreChecksDetail` в файле `Script-2.sql`. В `RankedPreChecksDetail` добавляется определение типа чека, а в `FilteredPreChecksDetail` применяется логика ветвления для обработки чеков возврата и чеков продаж.
- **Предпочтительный подход**: Реализовать логику таким образом, чтобы минимизировать изменения в финальном `SELECT` запросе.

## Assumptions
- Отмена позиции всегда представлена записью с тем же `objectnumber` и отрицательным значением количества/суммы.
- Операции продажи и отмены всегда происходят в рамках одного и того же чека (`checkid`).
- При частичной отмене аннулируются последние по времени (или по `detailindex`) продажи. *Примечание: в требованиях выше указано обратное - сохранять самые ранние. Это нужно для консистентности.*
