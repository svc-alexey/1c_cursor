## Title
Интеграция с Oracle Micros: Загрузка данных о продажах и акцизных марках

## Context & Goals

### Problem & background
Для корректного ведения складского и финансового учета необходимо обеспечить автоматическую передачу данных о розничных продажах из кассовой системы (POS) Oracle Micros в 1С:ERP. Данные должны включать детализированную информацию по чекам, включая проданные товары, скидки, типы оплат, а также данные по акцизным маркам для алкогольной продукции для целей отчетности в ЕГАИС.

### Objectives
- **Автоматизировать** ежедневную загрузку данных по чекам из основной базы данных Oracle Micros в 1С.
- **Автоматизировать** загрузку данных по проданным акцизным маркам из фискальных баз данных Micros (SQLite).
- **Обеспечить связь** между данными о продажах и соответствующими акцизными марками в системе 1С.
- **Сформировать** в 1С документы, являющиеся основанием для складского, бухгалтерского и управленческого учета.
- **Создать** основу для последующего анализа продаж и контроля за реализацией алкогольной продукции.

### Non-goals / Out of scope
- Обмен данными в режиме реального времени.
- Выгрузка каких-либо данных из 1С в Oracle Micros (однонаправленная интеграция).
- Интеграция с другими системами, кроме Oracle Micros и связанных с ней фискальных БД.

## Core functions
- **Загрузка чеков**: Фоновое задание подключается к БД Oracle Micros и загружает данные о продажах за определенный период в `Документ.питДанныеПродажФронта`.
- **Загрузка акцизных марок**: В процессе загрузки чеков система обращается к фискальным базам данных SQLite для получения информации о проданных акцизных марках.
- **Сопоставление данных**: Используются регистры сведений для сопоставления кодов объектов из Micros (товары, кассы) с соответствующими справочниками в 1С (`Номенклатура`, `КассыККМ`).
- **Консолидация данных**: Данные по акцизным маркам прикрепляются к соответствующим товарным строкам в документе продажи (`питДанныеПродажФронта`, табличная часть `УчетАлкоголя`).
- **Фоновое выполнение**: Все процессы загрузки данных выполняются в фоновом режиме по настроенному расписанию.

## Flows (Text-Only)

### 1. Поток загрузки чеков
1.  **Инициация**: Процесс запускается автоматически через `РегламентноеЗадание.MRS_ЗагрузкаЧековMicros`.
2.  **Определение периода**: Система вычисляет период для загрузки данных. Дата начала — это дата последнего успешно загруженного чека (из `РегистрСведений.ДатыЗапретаИзменения` или дата последнего документа `питДанныеПродажФронта`) + 1 день. Дата окончания — предыдущий день от текущей даты.
3.  **Подключение к Oracle Micros**: Используя параметры из `РегистрСведений.MRS_НастройкиПодключенияКФронтСистемам`, система устанавливает соединение с базой данных Oracle через ADODB COM.
4.  **Получение данных о продажах**: Выполняется SQL-запрос к БД Micros, который извлекает полную информацию по чекам за заданный период. **Запрос не должен сворачивать данные по товарам, а должен возвращать каждую позицию в чеке отдельно.** Для корректного расчета итогов по чеку без группировки используются оконные функции SQL.
    -   Данные заголовка чека (номер, дата открытия/закрытия, номер кассы).
    -   Товарные строки (код товара, наименование, количество, цена, сумма, **номер позиции в чеке - `detailindex`**).
    -   Данные о скидках.
    -   Данные о типах оплат.
5.  **Запуск потока загрузки марок**: Система инициирует внутренний поток для получения данных об акцизных марках (см. "Поток загрузки акцизных марок") для того же периода.
6.  **Обработка и создание документов**:
    -   Система итерирует по полученным данным, группируя строки по каждому чеку.
    -   Для каждого уникального чека создается или находится существующий `Документ.питДанныеПродажФrontа`.
    -   Заполняются реквизиты шапки документа: `Организация`, `КассаККМ`, `Дата`, `НомерЧека`.
    -   Заполняется табличная часть `Товары` на основе товарных строк из чека.
    -   Заполняется табличная часть `Оплаты` на основе данных об оплате.
    -   Заполняется табличная часть `УчетАлкоголя` данными из потока загрузки марок. **Сопоставление марки с товарной строкой происходит по номеру позиции в чеке: `detailindex` из Oracle и `ckpos` из SQLite.** В коде это реализовано в процедуре `ЗаписатьВБазу` (`MRS_МенеджерОбменаMicros`), где полю `НомерСтрокиОсновнойПозиции` присваивается значение `ПозицияЧека` из данных о марках.
7.  **Сохранение и завершение**:
    -   Созданный или обновленный документ `питДанныеПродажФронта` записывается в базу.
    -   В случае успешной загрузки всего периода, дата запрета (`ДатаЗапретаПодключения`) в `РегистрСведений.MRS_НастройкиПодключенияКФронтСистемам` сдвигается на текущую дату, чтобы предотвратить повторную загрузку.

### 2. Поток загрузки акцизных марок
1.  **Инициация**: Запускается из основного потока загрузки чеков.
2.  **Получение настроек**: Система считывает настройки подключения ко всем доступным фискальным базам из `РегистрСведений.MRS_НастройкиПодключенияFiscalDBFront`.
3.  **Подключение к SQLite**: Для каждой настроенной базы данных система устанавливает соединение через ODBC-драйвер SQLite к файлу `FiscalDB.db3`.
4.  **Получение данных о марках**: Выполняется SQL-запрос к таблицам `excisemarks` и `markcodes` для извлечения кодов проданных марок **и номера позиции в чеке (`ckpos`)** за период, указанный основным потоком.
5.  **Агрегация и обработка**:
    -   Данные из всех фискальных баз объединяются в единую таблицу.
    -   Производится фильтрация и валидация кодов марок (проверка длины и допустимых символов).
    -   Данные обогащаются: на основе кода марки находятся соответствующие элементы в справочниках 1С (`ШтрихкодыУпаковокТоваров`, `СерииНоменклатуры`, `Номенклатура`, `АлкогольнаяПродукция`).
6.  **Возврат данных**: Обработанная таблица с акцизными марками **и их позициями в чеке** возвращается в основной поток загрузки чеков для дальнейшей привязки к документам.

## Data & Integrations

### Core 1C Entities

| Объект 1С                                      | Назначение                                                                                                    |
| ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| `Документ.питДанныеПродажФронта`                  | Основной документ, хранящий данные о розничных продажах из Micros.                                            |
| `РегистрСведений.MRS_АкцизныеМаркиПроданныхБутылок` | Дополнительный регистр для хранения и анализа данных о проданных акцизных марках.                             |
| `РегистрСведений.ПЛ_СоответствиеСФронтСистемами`   | Регистр для сопоставления кодов (ID) объектов из Micros (товары, кассы) с объектами 1С.                      |
| `РегистрСведений.MRS_НастройкиПодключенияКФронтСистемам` | Хранит параметры подключения к основной базе данных Oracle Micros.                                              |
| `РегистрСведений.MRS_НастройкиПодключенияFiscalDBFront` | Хранит параметры подключения к фискальным базам данных SQLite.                                                |
| `РегистрСведений.ДатыЗапретаИзменения`         | Используется для определения даты начала периода загрузки.                                                   |

### External Systems / APIs

| Система                      | Тип                      | Протокол/Технология | Назначение                                  |
| ---------------------------- | ------------------------ | ------------------- | ------------------------------------------- |
| **Oracle Micros Database**   | База данных              | ADODB COM           | Источник данных о продажах (чеки).          |
| **SQLite Fiscal Database**   | Файловая база данных     | ODBC                | Источник данных о проданных акцизных марках.|

## План по улучшению производительности

### Контекст
Текущий процесс загрузки чеков и акцизных марок из Oracle Micros, особенно запись документов `питДанныеПродажФронта`, может занимать продолжительное время при больших объемах данных. Это создает риски для стабильности и масштабируемости интеграции.

### Цели
- Сократить время ежедневной загрузки данных не менее чем на 50%.
- Снизить нагрузку на серверы 1С и Oracle Micros во время обмена.
- Устранить узкое место, связанное с последовательной записью документов в 1С.

### Предлагаемые шаги

| Приоритет | Шаг                                | Описание                                                                                                                                                                                                                                                                                                                                                                | Статус |
|-----------|------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---|
| **Must**  | **1. Пакетная запись документов**    | Модифицировать процедуру `ЗаписатьВБазу`. Вместо последовательной записи каждого документа `питДанныеПродажФронта` в цикле, реализовать пакетную запись. Все подготовленные объекты документов следует собрать в массив и записывать их группами (пакетами) в рамках одной транзакции (например, по 100 документов). Это значительно снизит количество обращений к СУБД и накладные расходы на транзакции. | **Выполнено** |
| **Should**| **2. Анализ и оптимизация SQL-запроса**| Провести детальный анализ плана выполнения SQL-запроса в `ПолучениеДанныхORACLE` на стороне Oracle. Определить и создать недостающие индексы для ключевых таблиц (`check_detail`, `checks`). Рассмотреть возможность упрощения запроса, например, путем вынесения части логики по обогащению данных в 1С после получения "сырых" данных.                                                 | **В процессе** |
| **Done**  | **3. Параллельная обработка данных** | Механизм фонового задания `MRS_ЗагрузкаЧековMicros` уже поддерживает параллельную загрузку по разным точкам продаж, что является хорошей практикой.                                                              | **Выполнено** |
| **Done**  | **4. Мониторинг и профилирование**  | В процесс загрузки встроен механизм логирования ключевых этапов с замером времени, что позволяет выявлять "узкие места".                                                                                                    | **Выполнено** |

## Metadata

### 1C Objects

-   **Общие модули**:
    -   `MRS_МенеджерОбменаMicros`
    -   `MRS_ЗагрузкаЕГАИСФронт`
-   **Документы**:
    -   `питДанныеПродажФронта`
-   **Регистры сведений**:
    -   `MRS_НастройкиПодключенияКФронтСистемам`
    -   `MRS_НастройкиПодключенияFiscalDBFront`
    -   `ПЛ_СоответствиеСФронтСистемами`
    -   `MRS_АкцизныеМаркиПроданныхБутылок`
    -   `ДатыЗапретаИзменения`
-   **Регламентные задания**:
    -   `MRS_ЗагрузкаЧековMicros`
    -   `MRS_ЗагрузкаАкцизныхМарокИзФронтаMRIYAВФоне` (и аналогичные для других объектов)
-   **Планы видов характеристик**:
    - `ПЛ_ТипыОбъектовФронтСистем`
-   **Перечисления**:
    - `ПЛ_ТипыФронтСистем`
