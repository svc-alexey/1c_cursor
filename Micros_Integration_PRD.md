## Title
Интеграция с Oracle Micros: Загрузка данных о продажах и акцизных марках
## Context & Goals
### Problem & background
Для корректного ведения складского и финансового учета необходимо обеспечить автоматическую передачу данных о розничных продажах из кассовой системы (POS) Oracle Micros в 1С:ERP. Данные должны включать детализированную информацию по чекам, включая проданные товары, скидки, типы оплат, а также данные по акцизным маркам для алкогольной продукции для целей отчетности в ЕГАИС.
### Objectives
- **Автоматизировать** ежедневную загрузку данных по чекам из основной базы данных Oracle Micros в 1С.
- **Автоматизировать** загрузку данных по проданным акцизным маркам из фискальных баз данных Micros (SQLite).
- **Обеспечить связь** между данными о продажах и соответствующими акцизными марками в системе 1С.
- **Сформировать** в 1С документы, являющиеся основанием для складского, бухгалтерского и управленческого учета.
- **Создать** основу для последующего анализа продаж и контроля за реализацией алкогольной продукции.
### Non-goals / Out of scope
- Обмен данными в режиме реального времени.
- Выгрузка каких-либо данных из 1С в Oracle Micros (однонаправленная интеграция).
- Интеграция с другими системами, кроме Oracle Micros и связанных с ней фискальных БД.
## План доработок по задаче MRS-230
| Приоритет | Шаг | Описание | Статус |
|---|---|---|---|
| **Must** | **1. Добавление поля `MRS_ПозицияВЧеке`** | В документ `питДанныеПродажФронта` в табличную часть `Товары` добавлено поле `MRS_ПозицияВЧеке` (тип `Число`) для хранения номера строки из чека Micros. | **Выполнено** |
| **Must** | **2. Изменение логики загрузки** | В общем модуле `MRS_МенеджерОбменаMicros` (процедура `ЗаписатьВБазу`) добавлено заполнение нового поля `MRS_ПозицияВЧеке` значением `НомерПозицииВЧеке`, получаемым из Oracle. | **Выполнено** |
| **Must** | **3. Адаптация отчета сверки** | В общем модуле `MRS_МенеджерОбменаMicros` (процедура `ДобавитьЧекиКСверке`), который готовит данные для отчета, изменено условие соединения данных из Micros и 1С. Добавлено сопоставление по полю `MRS_ПозицияВЧеке`. Также в схему компоновки данных отчета (`СхемаКомпоновкиMicros`) добавлены новые поля для отображения позиций. | **Выполнено** |
## Core functions
- **Загрузка чеков**: Фоновое задание подключается к БД Oracle Micros и загружает данные о продажах за определенный период в `Документ.питДанныеПродажФронта`.
- **Загрузка акцизных марок**: В процессе загрузки чеков система обращается к фискальным базам данных SQLite для получения информации о проданных акцизных марках.
- **Сопоставление данных**: Используются регистры сведений для сопоставления кодов объектов из Micros (товары, кассы) с соответствующими справочниками в 1С (`Номенклатура`, `КассыККМ`).
- **Консолидация данных**: Данные по акцизным маркам прикрепляются к соответствующим товарным строкам в документе продажи (`питДанныеПродажФронта`, табличная часть `УчетАлкоголя`).
- **Фоновое выполнение**: Все процессы загрузки данных выполняются в фоновом режиме по настроенному расписанию.
## Flows (Text-Only)
### 1. Поток загрузки чеков
1. **Инициация**: Процесс запускается автоматически через `РегламентноеЗадание.MRS_ЗагрузкаЧековMicros`.
2. **Определение периода**: Система вычисляет период для загрузки данных. Дата начала — это дата последнего успешно загруженного чека (из `РегистрСведений.ДатыЗапретаИзменения` или дата последнего документа `питДанныеПродажФронта`) + 1 день. Дата окончания — предыдущий день от текущей даты.
3. **Подключение к Oracle Micros**: Используя параметры из `РегистрСведений.MRS_НастройкиПодключенияКФронтСистемам`, система устанавливает соединение с базой данных Oracle через ADODB COM.
4. **Получение данных о продажах**: Выполняется SQL-запрос к БД Micros, который извлекает полную информацию по чекам за заданный период. **Запрос не должен сворачивать данные по товарам, а должен возвращать каждую позицию в чеке отдельно.** Для корректного расчета итогов по чеку без группировки используются оконные функции SQL.
    - Данные заголовка чека (номер, дата открытия/закрытия, номер кассы).
    - Товарные строки (код товара, наименование, количество, цена, сумма, **номер позиции в чеке - `detailindex`**).
    - Данные о скидках.
    - Данные о типах оплат.
5. **Запуск потока загрузки марок**: Система инициирует внутренний поток для получения данных об акцизных марках (см. "Поток загрузки акцизных марок") для того же периода.
6. **Обработка и создание документов**:
    - Система итерирует по полученным данным, группируя строки по каждому чеку.
    - Для каждого уникального чека создается или находится существующий `Документ.питДанныеПродажФrontа`.
    - Заполняются реквизиты шапки документа: `Организация`, `КассаККМ`, `Дата`, `НомерЧека`.
    - Заполняется табличная часть `Товары` на основе товарных строк из чека.
    - Заполняется табличная часть `Оплаты` на основе данных об оплате.
    - Заполняется табличная часть `УчетАлкоголя` данными из потока загрузки марок. **Сопоставление марки с товарной строкой происходит по номеру позиции в чеке: `detailindex` из Oracle и `ckpos` из SQLite.** В коде это реализовано в процедуре `ЗаписатьВБазу` (`MRS_МенеджерОбменаMicros`), где полю `НомерСтрокиОсновнойПозиции` присваивается значение `ПозицияЧека` из данных о марках.
7. **Сохранение и завершение**:
    - Созданный или обновленный документ `питДанныеПродажФронта` записывается в базу.
    - В случае успешной загрузки всего периода, дата запрета (`ДатаЗапретаПодключения`) в `РегистрСведений.MRS_НастройкиПодключенияКФронтСистемам` сдвигается на текущую дату, чтобы предотвратить повторную загрузку.
### 2. Поток загрузки акцизных марок
1. **Инициация**: Запускается из основного потока загрузки чеков.
2. **Получение настроек**: Система считывает настройки подключения ко всем доступным фискальным базам из `РегистрСведений.MRS_НастройкиПодключенияFiscalDBFront`.
3. **Подключение к SQLite**: Для каждой настроенной базы данных система устанавливает соединение через ODBC-драйвер SQLite к файлу `FiscalDB.db3`.
4. **Получение данных о марках**: Выполняется SQL-запрос к таблицам `excisemarks` и `markcodes` для извлечения кодов проданных марок **и номера позиции в чеке (`ckpos`)** за период, указанный основным потоком.
5. **Агрегация и обработка**:
    - Данные из всех фискальных баз объединяются в единую таблицу.
    - Производится фильтрация и валидация кодов марок (проверка длины и допустимых символов).
    - Данные обогащаются: на основе кода марки находятся соответствующие элементы в справочниках 1С (`ШтрихкодыУпаковокТоваров`, `СерииНоменклатуры`, `Номенклатура`, `АлкогольнаяПродукция`).
6. **Возврат данных**: Обработанная таблица с акцизными марками **и их позициями в чеке** возвращается в основной поток загрузки чеков для дальнейшей привязки к документам.
## Data & Integrations
### Core 1C Entities
| Объект 1С | Назначение |
|---|---|
| `Документ.питДанныеПродажФронта` | Основной документ, хранящий данные о розничных продажах из Micros. |
| `РегистрСведений.MRS_АкцизныеМаркиПроданныхБутылок` | Дополнительный регистр для хранения и анализа данных о проданных акцизных марках. |
| `РегистрСведений.ПЛ_СоответствиеСФронтСистемами` | Регистр для сопоставления кодов (ID) объектов из Micros (товары, кассы) с объектами 1С. |
| `РегистрСведений.MRS_НастройкиПодключенияКФронтСистемам` | Хранит параметры подключения к основной базе данных Oracle Micros. |
| `РегистрСведений.MRS_НастройкиПодключенияFiscalDBFront` | Хранит параметры подключения к фискальным базам данных SQLite. |
| `РегистрСведений.ДатыЗапретаИзменения` | Используется для определения даты начала периода загрузки. |
### External Systems / APIs
| Система | Тип | Протокол/Технология | Назначение |
|---|---|---|---|
| **Oracle Micros Database** | База данных | ADODB COM | Источник данных о продажах (чеки). |
| **SQLite Fiscal Database** | Файловая база данных | ODBC | Источник данных о проданных акцизных марках.|
## План по улучшению производительности
### Контекст
Текущий процесс загрузки чеков и акцизных марок из Oracle Micros, особенно запись документов `питДанныеПродажФронта`, может занимать продолжительное время при больших объемах данных. Это создает риски для стабильности и масштабируемости интеграции.
### Цели
- Сократить время ежедневной загрузки данных не менее чем на 50%.
- Снизить нагрузку на серверы 1С и Oracle Micros во время обмена.
- Устранить узкое место, связанное с последовательной записью документов в 1С.
### Предлагаемые шаги
| Приоритет | Шаг | Описание | Статус |
|---|---|---|---|
| **Must** | **1. Пакетная запись документов** | Модифицировать процедуру `ЗаписатьВБазу`. Вместо последовательной записи каждого документа `питДанныеПродажФронта` в цикле, реализовать пакетную запись. Все подготовленные объекты документов следует собрать в массив и записывать их группами (пакетами) в рамках одной транзакции (например, по 100 документов). Это значительно снизит количество обращений к СУБД и накладные расходы на транзакции. | **Выполнено** |
| **Should**| **2. Анализ и оптимизация SQL-запроса**| Провести детальный анализ плана выполнения SQL-запроса в `ПолучениеДанныхORACLE` на стороне Oracle. Определить и создать недостающие индексы для ключевых таблиц (`check_detail`, `checks`). Рассмотреть возможность упрощения запроса, например, путем вынесения части логики по обогащению данных в 1С после получения "сырых" данных. | **В процессе** |
| **Done** | **3. Параллельная обработка данных** | Механизм фонового задания `MRS_ЗагрузкаЧековMicros` уже поддерживает параллельную загрузку по разным точкам продаж, что является хорошей практикой. | **Выполнено** |
| **Done** | **4. Мониторинг и профилирование** | В процесс загрузки встроен механизм логирования ключевых этапов с замером времени, что позволяет выявлять "узкие места". | **Выполнено** |
## Адаптация отчета "Сверка продаж Micros"
### Контекст и цели
- **Проблема:** Отчет по сверке продаж (`MRS_ПродажиФронтСистем`), использующий внешний источник данных, некорректно сопоставлял строки, что приводило к их дублированию.
- **Цели:**
    - Обеспечить **построчную сверку** данных Micros и 1С, используя номер позиции в чеке.
    - Устранить дублирование строк и гарантировать **точный расчет всех итогов**.
### Сценарии использования
- **Системный сценарий (реализованные изменения):**
    1. Процедура `ДобавитьЧекиКСверке` в общем модуле `MRS_МенеджерОбменаMicros` формирует таблицу `ТаблицаЗначенийMicros`, которая используется как внешний источник данных для отчета.
    2. В SQL-запросе внутри этой процедуры было изменено `ЛЕВОЕ СОЕДИНЕНИЕ` между данными Micros (`ТаблицаORACLE`) и данными 1С (`Документ.питДанныеПродажФронта.Товары`). **Добавлено условие по номеру позиции**: `ТаблицаORACLE.НомерПозицииВЧеке = питДанныеПродажФронтаТовары.MRS_ПозицияВЧеке`.
    3. В схему компоновки данных отчета `СхемаКомпоновкиMicros` были добавлены новые поля (`НомерПозицииВЧекеORACLE`, `ПозицияВЧекеЧекОбщепита`) для возможности их отображения в отчете.
    4. **Результат:** Отчет теперь корректно сопоставляет строки, устраняя дублирование и позволяя проводить точную построчную сверку.
## Metadata
### 1C Objects
-   **Общие модули**:
    -   `MRS_МенеджерОбменаMicros`
    -   `MRS_ЗагрузкаЕГАИСФронт`
-   **Документы**:
    -   `питДанныеПродажФронта`
-   **Регистры сведений**:
    -   `MRS_НастройкиПодключенияКФронтСистемам`
    -   `MRS_НастройкиПодключенияFiscalDBFront`
    -   `ПЛ_СоответствиеСФронтСистемами`
    -   `MRS_АкцизныеМаркиПроданныхБутылок`
    -   `ДатыЗапретаИзменения`
-   **Регламентные задания**:
    -   `MRS_ЗагрузкаЧековMicros`
    -   `MRS_ЗагрузкаАкцизныхМарокИзФронтаMRIYAВФоне` (и аналогичные для других объектов)
-   **Планы видов характеристик**:
    - `ПЛ_ТипыОбъектовФронтСистем`
-   **Перечисления**:
    - `ПЛ_ТипыФронтСистем`
-   **Отчеты**:
    - `MRS_ПродажиФронтСистем` (схема `СхемаКомпоновкиMicros`)

## План доработок отчета "Сверка продаж Micros" (Задачи MRS-241, MRS-242)
### Контекст и цели
- **Проблема:** Текущая версия отчета по сверке продаж содержит несколько критических недостатков: некорректно рассчитывается сумма продаж для позиций со 100% скидкой, строки чека могут загружаться и отображаться в неправильном порядке, а также отсутствует наглядная визуализация расхождений данных. Это снижает достоверность отчета и требует от пользователей значительных усилий по ручной проверке данных.
- **Цели:**
    - **(Must)** Обеспечить корректный расчет поля "Сумма продаж (Micros)" с учетом 100% скидок, когда сумма чека равна нулю.
    - **(Must)** Гарантировать, что строки в чеке всегда отсортированы по номеру позиции (`detailindex`) при загрузке и отображении.
    - **(Must)** Реализовать условное форматирование для визуального выделения расхождений между данными Micros и 1С на уровне всего чека и на уровне отдельных полей.

### Детальные требования
#### 1. Исправление расчета суммы продаж при 100% скидке
- **Сценарий:** В чеке из Micros присутствует позиция со 100% скидкой. В выгрузке это отражается как `СУММАЧЕКАORACLE` = 0, при этом `СУММАТОВАРАORACLE` > 0, а поле `СУММАСКИДКИСТРОКИORACLE` может быть пустым или равно 0.
- **Требование:** Модифицировать выражение для вычисляемого поля `СуммаПродажORACLEИтоги` в схеме компоновки данных `СхемаКомпоновкиMicros`. Новая логика должна обрабатывать этот случай: если `СУММАЧЕКАORACLE` = 0, то итоговая сумма продаж по строке также должна быть равна 0, игнорируя промежуточные расчеты. В противном случае должна применяться существующая формула (`СУММАТОВАРАORACLE - СУММАСКИДКИСТРОКИORACLE`).

#### 2. Сортировка строк чека
- **Сценарий:** При формировании данных для отчета строки одного и того же чека могут следовать не в том порядке, в котором они были в исходном чеке.
- **Требование:** В общем модуле `MRS_МенеджерОбменаMicros`, в процедуре, отвечающей за подготовку данных для отчета (например, `ДобавитьЧекиКСверке`), необходимо добавить принудительную сортировку итоговой таблицы `ТаблицаЗначенийMicros`. Сортировка должна выполняться по полям `НОМЕРЧЕКАORACLE` и `НомерПозицииВЧекеORACLE` (по возрастанию).

#### 3. Условное оформление для выделения расхождений
- **Сценарий:** В отчете присутствуют расхождения между данными из Micros и данными, загруженными в 1С.
- **Требования:** Настроить условное оформление в `СхемаКомпоновкиMicros`:
    - **Выделение чека с расхождениями (желтый фон):**
        - **Условие:** Если для группировки по чеку (`НОМЕРЧЕКАORACLE`) общая сумма по полю `РазницаСумм` не равна 0.
        - **Действие:** Вся группировка по чеку (включая заголовок и все строки) должна быть выделена желтым цветом фона.
    - **Выделение ячеек с расхождениями (красный фон):**
        - **Условие 1:** Значение в поле `РазницаСумм` для строки не равно 0.
        - **Действие 1:** Выделить красным цветом фона ячейки `СуммаПродажORACLEИтоги` и `СуммаПродажИтоги` в этой строке.
        - **Условие 2:** `КОЛИЧЕСТВОТОВАРАORACLE` <> `КоличествоЧекОбщепита`.
        - **Действие 2:** Выделить красным цветом фона ячейки `КОЛИЧЕСТВОТОВАРАORACLE` и `КоличествоЧекОбщепита` в этой строке.
        - **Условие 3:** `СУММАСКИДКИСТРОКИORACLE` <> `СуммаСкидкиЧекОбщепита`.
        - **Действие 3:** Выделить красным цветом фона ячейки `СУММАСКИДКИСТРОКИORACLE` и `СуммаСкидкиЧекОбщепита` в этой строке.

### Затрагиваемые объекты метаданных
-   **Отчет `MRS_ПродажиФронтСистем`**:
    -   Необходимо внести изменения в схему компоновки данных `СхемаКомпоновкиMicros`:
        -   Изменить выражение для вычисляемого поля `СуммаПродажORACLEИтоги`.
        -   Добавить новые правила условного оформления.
-   **Общий модуль `MRS_МенеджерОбменаMicros`**:
    -   Необходимо модифицировать процедуру подготовки данных для отчета, добавив сортировку таблицы-источника.

## План доработок: Обработка объединенных чеков Micros (Задача MRS-XXX)
### Контекст и цели
- **Проблема:** В Micros существует функциональность объединения нескольких физических чеков в один логический заказ (например, при оплате одного стола с разных касс). Такие чеки имеют общий идентификатор (`checkid`), но в 1С загружаются как отдельные, не связанные документы `питДанныеПродажФронта`. Общая скидка по заказу может быть применена только к одному из чеков, что приводит к некорректным данным при сверке продаж по каждой отдельной кассе.
- **Цели:**
    - **(Must)** Обеспечить хранение единого идентификатора (`checkid`) для всех частей объединенного чека.
    - **(Must)** Модифицировать механизм загрузки и сверки данных так, чтобы при выборе одной части чека для анализа система автоматически подгружала все остальные его части.
    - **(Must)** Добавить в отчет по сверке визуальный признак, указывающий на то, что чек является частью объединенного заказа.

### Детальные требования
#### 1. Сохранение идентификатора объединенного чека
- **Требование:** Необходимо обеспечить запись идентификатора объединенного чека из Micros (`cd.checkid`) в существующий реквизит `MRS_IDOracle` документа `питДанныеПродажФронта`.
    - **Шаг 1:** Убедиться, что SQL-запрос в общем модуле `MRS_МенеджерОбменаMicros` (процедура `ПолучениеДанныхORACLE`) извлекает поле `cd.checkid`.
    - **Шаг 2:** В процедуре `ЗаписатьВБазу` того же модуля добавить логику заполнения реквизита `MRS_IDOracle` для каждого создаваемого документа `питДанныеПродажФронта`.

#### 2. Обработка объединенных чеков при загрузке и сверке
- **Сценарий:** Пользователь в обработке `MRS_ЗагрузкаДанныхИзФронтСистем` инициирует сверку или загрузку по конкретному чеку, который является частью объединенного.
- **Требование:** Модифицировать логику в общем модуле `MRS_МенеджерОбменаMicros` (процедуры `ВыполнитьЗагрузкуДанныхMicros` и `ВыполнитьПолучениеДанныхMicros`).
    - **Логика:** При запросе данных по одному чеку система должна сначала получить его `MRS_IDOracle`. Затем выполнить повторный запрос к Oracle, чтобы найти все чеки с тем же `MRS_IDOracle` и той же датой, но с другими точками продаж (`revenue_center_id`). Все найденные части объединенного чека должны быть возвращены для совместной обработки (загрузки или сверки).

#### 3. Адаптация отчета "Сверка продаж Micros"
- **Сценарий:** В отчете сверки отображается чек, который является частью объединенного заказа.
- **Требования:**
    - **Шаг 1:** В процедуре `ДобавитьЧекиКСверке` (`MRS_МенеджерОбменаMicros`) добавить в итоговую таблицу `ТаблицаЗначенийMicros` новое поле-признак, например, `ОбъединенныйЧек` (Булево). Этот признак должен быть `Истина`, если в базе существует более одного документа `питДанныеПродажФронта` с тем же `MRS_IDOracle` и датой.
    - **Шаг 2:** В схеме компоновки данных `СхемаКомпоновкиMicros` отчета `MRS_ПродажиФронтСистем` добавить новое поле "Объединен".
    - **Шаг 3:** Вывести это поле в отчет. Рекомендуется настроить условное оформление для визуального выделения всей группы объединенных чеков (например, цветом фона или иконкой).

### Затрагиваемые объекты метаданных
-   **Документ `питДанныеПродажФронта`**:
    -   Используется существующий реквизит `MRS_IDOracle`.
-   **Общий модуль `MRS_МенеджерОбменаMicros`**:
    -   Модификация SQL-запроса в `ПолучениеДанныхORACLE`.
    -   Модификация процедуры `ЗаписатьВБазу`.
    -   Модификация процедур `ВыполнитьПолучениеДанныхMicros`, `ВыполнитьЗагрузкуДанныхMicros` и `ДобавитьЧекиКСверке`.
-   **Отчет `MRS_ПродажиФронтСистем`**:
    -   Изменение схемы компоновки данных `СхемаКомпоновкиMicros`.
