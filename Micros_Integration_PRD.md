## Title
Интеграция с Oracle Micros: Загрузка данных о продажах и акцизных марках
## Context & Goals
### Problem & background
Для корректного ведения складского и финансового учета необходимо обеспечить автоматическую передачу данных о розничных продажах из кассовой системы (POS) Oracle Micros в 1С:ERP. Данные должны включать детализированную информацию по чекам, включая проданные товары, скидки, типы оплат, а также данные по акцизным маркам для алкогольной продукции для целей отчетности в ЕГАИС.
### Objectives
- **Автоматизировать** ежедневную загрузку данных по чекам из основной базы данных Oracle Micros в 1С.
- **Автоматизировать** загрузку данных по проданным акцизным маркам из фискальных баз данных Micros (SQLite).
- **Обеспечить связь** между данными о продажах и соответствующими акцизными марками в системе 1С.
- **Сформировать** в 1С документы, являющиеся основанием для складского, бухгалтерского и управленческого учета.
- **Создать** основу для последующего анализа продаж и контроля за реализацией алкогольной продукции.
### Non-goals / Out of scope
- Обмен данными в режиме реального времени.
- Выгрузка каких-либо данных из 1С в Oracle Micros (однонаправленная интеграция).
- Интеграция с другими системами, кроме Oracle Micros и связанных с ней фискальных БД.
## Адаптация отчета "Сверка продаж Micros" (Задача MRS-230)

### Реализованное решение

1.  **Добавлено поле для связи**: В документ `питДанныеПродажФронта` (табличная часть `Товары`) добавлено поле `MRS_ПозицияВЧеке` для хранения номера строки (`detailindex`) из чека Micros.
2.  **Изменена логика загрузки**: Процедура загрузки данных из Oracle в общем модуле `MRS_МенеджерОбменаMicros` была модифицирована для заполнения нового поля `MRS_ПозицияВЧеке`.
3.  **Адаптирован отчет**:
    - В процедуре `ДобавитьЧекиКСверке` (`MRS_МенеджерОбменаMicros`), которая готовит данные для отчета, было изменено условие соединения таблиц. Теперь данные из Micros и 1С сопоставляются не только по чеку, но и по номеру позиции (`ТаблицаORACLE.НомерПозицииВЧеке = питДанныеПродажФронтаТовары.MRS_ПозицияВЧеке`).
    - В схему компоновки данных отчета (`СхемаКомпоновкиMicros`) были добавлены поля для отображения номеров позиций из обеих систем.

### Результат
В результате внесенных изменений отчет теперь корректно сопоставляет каждую строку чека из Micros с соответствующей строкой в документе 1С. Это позволило устранить дублирование, обеспечить точность итогов и проводить детальную построчную сверку данных.
## Core functions
- **Загрузка чеков**: Фоновое задание подключается к БД Oracle Micros и загружает данные о продажах за определенный период в `Документ.питДанныеПродажФронта`.
- **Загрузка акцизных марок**: В процессе загрузки чеков система обращается к фискальным базам данных SQLite для получения информации о проданных акцизных марках.
- **Сопоставление данных**: Используются регистры сведений для сопоставления кодов объектов из Micros (товары, кассы) с соответствующими справочниками в 1С (`Номенклатура`, `КассыККМ`).
- **Консолидация данных**: Данные по акцизным маркам прикрепляются к соответствующим товарным строкам в документе продажи (`питДанныеПродажФронта`, табличная часть `УчетАлкоголя`).
- **Фоновое выполнение**: Все процессы загрузки данных выполняются в фоновом режиме по настроенному расписанию.
## Flows (Text-Only)
### 1. Поток загрузки чеков
1. **Инициация**: Процесс запускается автоматически через `РегламентноеЗадание.MRS_ЗагрузкаЧековMicros`.
2. **Определение периода**: Система вычисляет период для загрузки данных. Дата начала — это дата последнего успешно загруженного чека (из `РегистрСведений.ДатыЗапретаИзменения` или дата последнего документа `питДанныеПродажФронта`) + 1 день. Дата окончания — предыдущий день от текущей даты.
3. **Подключение к Oracle Micros**: Используя параметры из `РегистрСведений.MRS_НастройкиПодключенияКФронтСистемам`, система устанавливает соединение с базой данных Oracle через ADODB COM.
4. **Получение данных о продажах**: Выполняется SQL-запрос к БД Micros, который извлекает полную информацию по чекам за заданный период. **Запрос не должен сворачивать данные по товарам, а должен возвращать каждую позицию в чеке отдельно.** Для корректного расчета итогов по чеку без группировки используются оконные функции SQL.
    - Данные заголовка чека (номер, дата открытия/закрытия, номер кассы).
    - Товарные строки (код товара, наименование, количество, цена, сумма, **номер позиции в чеке - `detailindex`**).
    - Данные о скидках.
    - Данные о типах оплат.
5. **Запуск потока загрузки марок**: Система инициирует внутренний поток для получения данных об акцизных марках (см. "Поток загрузки акцизных марок") для того же периода.
6. **Обработка и создание документов**:
    - Система итерирует по полученным данным, группируя строки по каждому чеку.
    - Для каждого уникального чека создается или находится существующий `Документ.питДанныеПродажФrontа`.
    - Заполняются реквизиты шапки документа: `Организация`, `КассаККМ`, `Дата`, `НомерЧека`.
    - Заполняется табличная часть `Товары` на основе товарных строк из чека.
    - Заполняется табличная часть `Оплаты` на основе данных об оплате.
    - Заполняется табличная часть `УчетАлкоголя` данными из потока загрузки марок. **Сопоставление марки с товарной строкой происходит по номеру позиции в чеке: `detailindex` из Oracle и `ckpos` из SQLite.** В коде это реализовано в процедуре `ЗаписатьВБазу` (`MRS_МенеджерОбменаMicros`), где полю `НомерСтрокиОсновнойПозиции` присваивается значение `ПозицияЧека` из данных о марках.
7. **Сохранение и завершение**:
    - Созданный или обновленный документ `питДанныеПродажФронта` записывается в базу.
    - В случае успешной загрузки всего периода, дата запрета (`ДатаЗапретаПодключения`) в `РегистрСведений.MRS_НастройкиПодключенияКФронтСистемам` сдвигается на текущую дату, чтобы предотвратить повторную загрузку.
### 2. Поток загрузки акцизных марок
1. **Инициация**: Запускается из основного потока загрузки чеков.
2. **Получение настроек**: Система считывает настройки подключения ко всем доступным фискальным базам из `РегистрСведений.MRS_НастройкиПодключенияFiscalDBFront`.
3. **Подключение к SQLite**: Для каждой настроенной базы данных система устанавливает соединение через ODBC-драйвер SQLite к файлу `FiscalDB.db3`.
4. **Получение данных о марках**: Выполняется SQL-запрос к таблицам `excisemarks` и `markcodes` для извлечения кодов проданных марок **и номера позиции в чеке (`ckpos`)** за период, указанный основным потоком.
5. **Агрегация и обработка**:
    - Данные из всех фискальных баз объединяются в единую таблицу.
    - Производится фильтрация и валидация кодов марок (проверка длины и допустимых символов).
    - Данные обогащаются: на основе кода марки находятся соответствующие элементы в справочниках 1С (`ШтрихкодыУпаковокТоваров`, `СерииНоменклатуры`, `Номенклатура`, `АлкогольнаяПродукция`).
6. **Возврат данных**: Обработанная таблица с акцизными марками **и их позициями в чеке** возвращается в основной поток загрузки чеков для дальнейшей привязки к документам.
## Data & Integrations
### Core 1C Entities
| Объект 1С | Назначение |
|---|---|
| `Документ.питДанныеПродажФронта` | Основной документ, хранящий данные о розничных продажах из Micros. |
| `РегистрСведений.MRS_АкцизныеМаркиПроданныхБутылок` | Дополнительный регистр для хранения и анализа данных о проданных акцизных марках. |
| `РегистрСведений.ПЛ_СоответствиеСФронтСистемами` | Регистр для сопоставления кодов (ID) объектов из Micros (товары, кассы) с объектами 1С. |
| `РегистрСведений.MRS_НастройкиПодключенияКФронтСистемам` | Хранит параметры подключения к основной базе данных Oracle Micros. |
| `РегистрСведений.MRS_НастройкиПодключенияFiscalDBFront` | Хранит параметры подключения к фискальным базам данных SQLite. |
| `РегистрСведений.ДатыЗапретаИзменения` | Используется для определения даты начала периода загрузки. |
### External Systems / APIs
| Система | Тип | Протокол/Технология | Назначение |
|---|---|---|---|
| **Oracle Micros Database** | База данных | ADODB COM | Источник данных о продажах (чеки). |
| **SQLite Fiscal Database** | Файловая база данных | ODBC | Источник данных о проданных акцизных марках.|
## План по улучшению производительности
### Контекст
Текущий процесс загрузки чеков и акцизных марок из Oracle Micros, особенно запись документов `питДанныеПродажФронта`, может занимать продолжительное время при больших объемах данных. Это создает риски для стабильности и масштабируемости интеграции.
### Цели
- Сократить время ежедневной загрузки данных не менее чем на 50%.
- Снизить нагрузку на серверы 1С и Oracle Micros во время обмена.
- Устранить узкое место, связанное с последовательной записью документов в 1С.
### Предлагаемые шаги
| Приоритет | Шаг | Описание | Статус |
|---|---|---|---|
| **Must** | **1. Пакетная запись документов** | Модифицировать процедуру `ЗаписатьВБазу`. Вместо последовательной записи каждого документа `питДанныеПродажФронта` в цикле, реализовать пакетную запись. Все подготовленные объекты документов следует собрать в массив и записывать их группами (пакетами) в рамках одной транзакции (например, по 100 документов). Это значительно снизит количество обращений к СУБД и накладные расходы на транзакции. | **Выполнено** |
| **Should**| **2. Анализ и оптимизация SQL-запроса**| Проведен анализ и оптимизация SQL-запроса. Реализована логика для корректной идентификации и исключения сторнированных позиций, а также для корректной обработки чеков возврата. | **Выполнено** |
| **Done** | **3. Параллельная обработка данных** | Механизм фонового задания `MRS_ЗагрузкаЧековMicros` уже поддерживает параллельную загрузку по разным точкам продаж, что является хорошей практикой. | **Выполнено** |
| **Done** | **4. Мониторинг и профилирование** | В процесс загрузки встроен механизм логирования ключевых этапов с замером времени, что позволяет выявлять "узкие места". | **Выполнено** |
## Логика фильтрации сторнированных позиций (voids)
### Основные функции
- Система должна идентифицировать тип чека: "чек продажи" (содержит хотя бы одну положительную позицию) или "чек возврата" (все позиции отрицательные).
- Для **чеков возврата** все строки должны быть включены в итоговую выгрузку без изменений.
- Для **чеков продажи** применяется следующая логика:
    - Для каждого товара (`objectnumber`) внутри чека должен быть рассчитан итоговый суммарный объем (`quantity`).
    - Если итоговый объем по товару равен нулю (например, продана 1 штука и отменена 1 штука), все строки по этому товару для данного чека должны быть исключены из выборки.
    - Если итоговый объем по товару больше нуля (частичная отмена, например, продано 3, отменена 1), в отчете должны остаться строки продаж в количестве, равном итоговому объему (в примере — 2 строки).

### Поток фильтрации
1.  Для каждого чека (`checkid`) определяется его тип на основе позиций в `transdb.check_detail`:
    - **Чек возврата**: если все строки для данного `checkid` имеют отрицательное значение `quantity`.
    - **Чек продажи**: если в чеке присутствует хотя бы одна строка с положительным `quantity`.
2.  На основе этого определения вводится поле `check_type` (`-1` для возврата, `1` для продажи).
3.  Если чек определен как **чек возврата** (`check_type = -1`), все его строки включаются в итоговую выборку без дополнительной фильтрации.
4.  Если чек определен как **чек продажи** (`check_type = 1`), к нему применяется следующая логика фильтрации:
    - В рамках чека (`checkid`) вычисляется итоговое количество по каждому коду товара (`objectnumber`), суммируя значения из поля `quantity`.
    - На основе этих расчетов формируется список товаров с "чистыми" продажами, где итоговое количество больше нуля.
    - Далее происходит фильтрация исходного набора данных:
        - Полностью удаляются строки по товарам, где итоговое количество равно нулю.
        - Для товаров с частичной отменой (итоговое количество > 0), из выборки удаляются все строки отмен (с отрицательным `quantity`) и соответствующее им количество строк продаж.
5.  **Правило выбора сохраняемых строк**: При частичной отмене в чеке продажи должны сохраняться самые ранние по порядку (`detailindex`) строки продаж. Например, если было продано 3 единицы товара (со строками 10, 15, 20) и отменена 1 единица, в итоговом отчете должны остаться строки с `detailindex` 10 и 15.
6.  Отфильтрованный набор данных передается дальше для финального формирования отчета.
## Metadata
### 1C Objects
-   **Общие модули**:
    -   `MRS_МенеджерОбменаMicros`
    -   `MRS_ЗагрузкаЕГАИСФронт`
-   **Документы**:
    -   `питДанныеПродажФронта`
-   **Регистры сведений**:
    -   `MRS_НастройкиПодключенияКФронтСистемам`
    -   `MRS_НастройкиПодключенияFiscalDBFront`
    -   `ПЛ_СоответствиеСФронтСистемами`
    -   `MRS_АкцизныеМаркиПроданныхБутылок`
    -   `ДатыЗапретаИзменения`
-   **Регламентные задания**:
    -   `MRS_ЗагрузкаЧековMicros`
    -   `MRS_ЗагрузкаАкцизныхМарокИзФронтаMRIYAВФоне` (и аналогичные для других объектов)
-   **Планы видов характеристик**:
    - `ПЛ_ТипыОбъектовФронтСистем`
-   **Перечисления**:
    - `ПЛ_ТипыФронтСистем`
-   **Отчеты**:
    - `MRS_ПродажиФронтСистем` (схема `СхемаКомпоновкиMicros`)

## Реализованные доработки отчета "Сверка продаж Micros" (Задачи MRS-241, MRS-242)
### Контекст
Текущая версия отчета по сверке продаж содержала несколько недостатков: некорректно рассчитывалась сумма продаж для позиций со 100% скидкой, строки чека могли отображаться в неправильном порядке, а также отсутствовала наглядная визуализация расхождений. Это снижало достоверность отчета и усложняло ручную проверку.

### Реализованная функциональность
#### 1. Корректный расчет суммы продаж при 100% скидке
- **Описание:** Была исправлена логика расчета итоговой суммы в отчете. Для позиций, проданных со 100% скидкой (например, в рамках акции или для служебного питания), система теперь корректно отображает сумму продажи как 0. Это достигается за счет анализа соотношения суммы товарной строки и примененной скидки в схеме компоновки данных отчета (`СхемаКомпоновкиMicros`).

#### 2. Сортировка строк чека
- **Описание:** Для обеспечения консистентности данных и упрощения сверки, все строки внутри одного чека в отчете теперь принудительно сортируются по номеру позиции (`detailindex`) в том порядке, в котором они были в исходном чеке в Micros. Сортировка реализована в общем модуле `MRS_МенеджерОбменаMicros` при подготовке данных для отчета.

#### 3. Условное оформление для выделения расхождений
- **Описание:** Для быстрой визуальной идентификации проблемных данных в отчете реализовано условное форматирование:
    - **Выделение ячеек с расхождениями (красный фон):** Ячейки с количеством, суммой скидки или итоговой суммой подсвечиваются красным, если их значения в Micros и 1С не совпадают. Это позволяет пользователю мгновенно увидеть конкретное поле, в котором есть расхождение.
- **Ограничения:**
    - Выделение всей группы чека желтым цветом при наличии любого расхождения на данный момент **не реализовано**.

### Затрагиваемые объекты метаданных
-   **Отчет `MRS_ПродажиФронтСистем`**:
    -   Внесены изменения в схему компоновки данных `СхемаКомпоновкиMicros`:
        -   Изменено выражение для вычисляемого поля `СуммаПродажORACLEИтоги`.
        -   Добавлены правила условного оформления для полей.
-   **Общий модуль `MRS_МенеджерОбменаMicros`**:
    -   Модифицирована процедура `ДобавитьЧекиКСверке` для добавления сортировки.

## Обработка объединенных чеков Micros
### Контекст
В Micros существует функциональность объединения нескольких физических чеков в один логический заказ (например, при оплате одного стола с разных касс). Такие чеки имеют общий идентификатор (`checkid`), но ранее загружались в 1С как отдельные, не связанные документы. Это приводило к некорректным данным при сверке, так как общая скидка по заказу могла быть применена только к одному из чеков.

### Реализованная функциональность
#### 1. Сохранение идентификатора объединенного чека
- **Описание:** При загрузке данных из Micros система теперь извлекает единый идентификатор чека (`checkid`) и сохраняет его в реквизит `MRS_IDOracle` документа `питДанныеПродажФронта`. Это обеспечивает связь между всеми частями одного логического заказа внутри 1С.

#### 2. Визуализация в отчете "Сверка продаж Micros"
- **Описание:** В отчете по сверке реализован механизм для идентификации и визуализации объединенных чеков:
    - **Идентификация:** Логика в обработке `MRS_ЗагрузкаДанныхИзФронтСистем` анализирует загруженные данные и определяет чеки, у которых совпадает `MRS_IDOracle` и дата, но разные номера.
    - **Визуальный признак:** В отчет добавлено поле "Объединен". Если чек является частью объединенного заказа, это поле отмечается, и вся строка чека в отчете подсвечивается специальным цветом для привлечения внимания пользователя.

### Ограничения и дальнейшие доработки
- **Неполная загрузка:** Текущая реализация **не включает** механизм автоматической подгрузки всех частей объединенного чека, если пользователь запрашивает сверку или загрузку только по одной его части. Система обрабатывает только те данные, которые попадают в первоначальный период и фильтр по кассам. Для полной сверки объединенного заказа необходимо вручную выбирать все его составляющие.
- **Задача на доработку: Автоматический поиск связанных чеков по разным точкам продаж.** При поиске чека по его ID (`checkid`), система должна игнорировать текущий фильтр по точкам продаж. Вместо этого, она должна сначала найти все чеки с указанным ID, определить, к каким точкам продаж они относятся, а затем использовать полученный список точек продаж для финальной выборки всех данных, связанных с этим заказом. Это обеспечит полную загрузку объединенных заказов, даже если их части были оформлены на разных кассах.

### Затрагиваемые объекты метаданных
-   **Документ `питДанныеПродажФронта`**:
    -   Используется существующий реквизит `MRS_IDOracle` для хранения `checkid`.
-   **Общий модуль `MRS_МенеджерОбменаMicros`**:
    -   Модифицирован SQL-запрос для извлечения `checkid`.
    -   Изменена процедура `ЗаписатьВБазу` для заполнения `MRS_IDOracle`.
-   **Обработка `MRS_ЗагрузкаДанныхИзФронтСистем`**:
    -   В модуле объекта (`ObjectModule.bsl`) добавлена логика для определения объединенных чеков перед формированием отчета.
-   **Отчет `MRS_ПродажиФронтСистем`**:
    -   В схему компоновки данных `СхемаКомпоновкиMicros` добавлено поле "Объединен" и настроено условное оформление.
