## Title
Адаптация отчета "Сверка продаж Micros" для корректной обработки и отображения построчных данных чека

## Context & Goals
- **Проблема и предпосылки**
  Отчет по сверке продаж для системы Micros (`MRS_ПродажиФронтСистем`, использующий схему `СхемаКомпоновкиMicros`) некорректно обрабатывал детализированные данные о продажах. Это являлось следствием обновления общего модуля интеграции `MRS_МенеджерОбменаMicros`, который начал загружать данные построчно по каждой позиции в чеке. Текущая схема компоновки данных (СКД) была разработана для агрегированных данных, что приводило к неверному расчету итогов и отсутствию необходимой детализации.

- **Цели**
  - Модифицировать СКД `СхемаКомпоновкиMicros` для корректного отображения данных с иерархической структурой: **Дата -> Точка продаж -> Чек -> Строки чека**.
  - Обеспечить **отображение каждой товарной позиции** внутри чека со всеми необходимыми атрибутами (количество, сумма, скидка).
  - Гарантировать **точный расчет всех ресурсов** (сумма продаж, количество, скидки, сумма отклонений) и их корректную агрегацию на всех уровнях группировки (по чеку, по точке продаж, по дате и в общих итогах).
  - Четко разграничить в отчете данные, полученные из Micros, и данные из учетной системы 1С (`ЧекОбщепита`) для проведения сверки.

- **Вне рамок / Что не является целью**
  - Изменение логики загрузки данных в общем модуле `MRS_МенеджерОбменаMicros`.
  - Изменение структуры документа `питДанныеПродажФронта`.
  - Создание новых отчетов или обработок.

## Основные функции
- Отчет получает данные из внешней таблицы `ТаблицаЗначенийMicros`.
- Структура отчета обеспечивает иерархическую группировку данных: **Дата -> Точка продаж -> Чек**. Внутри каждого чека отображаются **детальные записи** по каждой товарной позиции.
- Все ресурсы отчета (Сумма, Количество, Скидка, Отклонение) корректно рассчитываются и агрегируются (суммируются) на всех уровнях группировки.

## Сценарии использования (Текстовое описание)
- **Пользовательский сценарий:**
  1. Пользователь открывает обработку "Загрузка данных из фронт-систем" (`MRS_ЗагрузкаДанныхИзФронтСистем`).
  2. Выбирает фронт-систему "Micros", указывает период и инициирует построение отчета сверки.

- **Системный сценарий (Требуемые изменения):**
  1. Модуль объекта обработки вызывает функцию `MRS_МенеджерОбменаMicros.ВыполнитьПолучениеДанныхMicros`, которая возвращает таблицу `ТаблицаЗначенийMicros`, где каждая строка соответствует одной товарной позиции из чека.
  2. Эта таблица передается как внешний источник данных в отчет `MRS_ПродажиФронтСистем`.
  3. СКД отчета, `СхемаКомпоновкиMicros`, должна быть настроена для корректной обработки этих данных.
  4. **Логика группировки данных:**
     - СКД должна иметь иерархическую структуру группировок:
       1. **Уровень 1:** `ДатаГруппировка` (Дата).
       2. **Уровень 2:** `НАИМЕНОВАНИЕТОЧКИПРОДАЖORACLE` (Точка продаж).
       3. **Уровень 3:** Группа по уникальному чеку (поля `НОМЕРЧЕКАORACLE` и `ДатаЗакрытияЧекаORACLE`).
       4. **Уровень 4:** Детальные записи (строки чека).
  5. **Логика расчета ресурсов:**
     - **Построчные данные:** Все ключевые показатели (`СуммаТовара`, `КоличествоТовара`, `СуммаСкидкиСтроки`) отображаются для каждой строки чека.
     - **Агрегация:** Все ресурсы должны агрегироваться с использованием функции `Сумма()`. Это включает в себя `СуммаПродажORACLEИтоги`, `СуммаПродажИтоги`, `СУММАСКИДКИСТРОКИORACLE` и `РазницаСумм`.
     - **Сумма чека:** Поле `СтоимостьЧека` (`СУММАЧЕКАORACLE`), которое дублируется в каждой строке, агрегируется с помощью функции `Максимум()` на уровне группировки по чеку, чтобы избежать многократного суммирования.
     - **Поля для сверки:**
        - `СуммаПродажORACLEИтоги` (Сумма продаж Micros) рассчитывается как `СУММАТОВАРАORACLE - СУММАСКИДКИСТРОКИORACLE`.
        - `СуммаПродажИтоги` (Сумма продаж 1С) рассчитывается на основе данных из документа `ЧекОбщепита`.
        - `РазницаСумм` — поле, показывающее отклонение между этими двумя источниками. **Наличие разницы является ожидаемым поведением и основной целью отчета.**

## Данные и Интеграции
- **Ключевые сущности и важные поля:**
  - **Внешний источник данных (`ТаблицаЗначенийMicros`):**
    - `НомерЧека`: Номер чека.
    - `ДатаЗакрытияЧека`: Дата и время закрытия чека.
    - `НомерТочкиПродаж`: Код точки продаж (кассы).
    - `КодТовара`: Код товарной позиции.
    - `КоличествоТовара`: Количество товара в строке.
    - `СуммаТовара`: Сумма по строке.
    - `СуммаСкидкиСтроки`: Сумма скидки по строке.
    - `СтоимостьЧека`: Общая сумма по всему чеку (повторяется в каждой строке).

- **Внешние системы:**
  - **Micros POS:** Источник данных. Интеграция осуществляется через прямой запрос к БД Oracle, определенный в `MRS_МенеджерОбменаMicros`. Изменений в контракте интеграции не требуется.

## Метаданные 1С
- **Отчет:** `MRS_ПродажиФронтСистем`
  - **Макет:** `СхемаКомпоновкиMicros`. Требуется модификация самой схемы компоновки данных внутри этого макета.
    - **Набор данных:** Проверить и при необходимости скорректировать поля, получаемые из внешнего объекта.
    - **Ресурсы:** Настроить агрегатные функции (`Сумма`, `Максимум`) для всех вычисляемых полей и итогов.
    - **Настройки структуры:** Настроить иерархическую группировку: по дате, затем по точке продаж, затем по чеку, с выводом детальных записей по строкам чека.
