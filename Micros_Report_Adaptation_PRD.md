## Title
Адаптация отчета "Сверка продаж Micros" для корректной обработки построчных данных чека

## Context & Goals
- **Проблема и предпосылки**
  Отчет по сверке продаж для системы Micros (`MRS_ПродажиФронтСистем`, использующий схему `СхемаКомпоновкиMicros`) отображает дублирующиеся данные о продажах и рассчитывает неверные итоговые суммы. Это является прямым следствием недавнего обновления общего модуля интеграции `MRS_МенеджерОбменаMicros`, который теперь загружает данные о продажах из Micros построчно по каждой позиции в чеке. Текущая схема компоновки данных (СКД) отчета была разработана для работы с агрегированными данными на уровне чека и не способна корректно сгруппировать новые, более детализированные данные.

- **Цели**
  - Модифицировать СКД `СхемаКомпоновкиMicros` для правильной группировки отдельных товарных позиций по родительскому чеку.
  - Обеспечить точный расчет всех ресурсов в отчете (например, общая сумма продаж, количество, скидки) путем их агрегации на уровне чека и для общих итогов по отчету.
  - Устранить дублирование сумм продаж в итоговом отчете.

- **Вне рамок / Что не является целью**
  - Изменение логики загрузки данных в общем модуле `MRS_МенеджерОбменаMicros`.
  - Изменение структуры документа `питДанныеПродажФронта`.
  - Создание новых отчетов или обработок.

## Основные функции
- Отчет должен получать данные из внешней таблицы `ТаблицаЗначенийMicros`, формируемой модулем `MRS_МенеджерОбменаMicros`.
- Структура отчета должна обеспечивать группировку данных по уникальным идентификаторам чека.
- Ресурсы отчета (Сумма, Количество, Скидка) должны рассчитываться с использованием агрегатных функций (например, `СУММА()`) на основе сгруппированных данных чека.

## Сценарии использования (Текстовое описание)
- **Пользовательский сценарий:**
  1. Пользователь открывает обработку "Загрузка данных из фронт-систем" (`MRS_ЗагрузкаДанныхИзФронтСистем`).
  2. Выбирает фронт-систему "Micros", указывает период и инициирует построение отчета сверки.

- **Системный сценарий (Требуемые изменения):**
  1. Модуль объекта обработки вызывает функцию `MRS_МенеджерОбменаMicros.ВыполнитьПолучениеДанныхMicros`, которая возвращает таблицу `ТаблицаЗначенийMicros`, где каждая строка соответствует одной товарной позиции из чека.
  2. Эта таблица передается как внешний источник данных в отчет `MRS_ПродажиФронтСистем`.
  3. СКД отчета, `СхемаКомпоновкиMicros`, должна быть настроена для корректной обработки этих данных.
  4. **Логика группировки данных:**
     - Основной набор данных в СКД должен быть сгруппирован по полям, которые уникально идентифицируют чек. Ожидаемый набор полей для группировки: `НомерЧека`, `ДатаЗакрытияЧека`, `НомерТочкиПродаж`.
  5. **Логика расчета ресурсов:**
     - Все поля-ресурсы в СКД (`СуммаТовара`, `КоличествоТовара`, `СуммаСкидкиСтроки` и т.д.) должны быть настроены на использование агрегатной функции `Сумма()`.
     - Поле `СтоимостьЧека` содержит общую сумму по чеку и дублируется для каждой товарной позиции. Его следует агрегировать с помощью функции `Максимум()` или `Среднее()` в пределах группы по чеку, чтобы избежать суммирования. Наиболее предпочтительный вариант — пересчитывать итог по чеку как сумму по полю `СуммаТовара` за вычетом `СуммаСкидкиСтроки` внутри группировки.

## Данные и Интеграции
- **Ключевые сущности и важные поля:**
  - **Внешний источник данных (`ТаблицаЗначенийMicros`):**
    - `НомерЧека`: Номер чека.
    - `ДатаЗакрытияЧека`: Дата и время закрытия чека.
    - `НомерТочкиПродаж`: Код точки продаж (кассы).
    - `КодТовара`: Код товарной позиции.
    - `КоличествоТовара`: Количество товара в строке.
    - `СуммаТовара`: Сумма по строке.
    - `СуммаСкидкиСтроки`: Сумма скидки по строке.
    - `СтоимостьЧека`: Общая сумма по всему чеку (повторяется в каждой строке).

- **Внешние системы:**
  - **Micros POS:** Источник данных. Интеграция осуществляется через прямой запрос к БД Oracle, определенный в `MRS_МенеджерОбменаMicros`. Изменений в контракте интеграции не требуется.

## Метаданные 1С
- **Отчет:** `MRS_ПродажиФронтСистем`
  - **Макет:** `СхемаКомпоновкиMicros`. Требуется модификация самой схемы компоновки данных внутри этого макета.
    - **Набор данных:** Необходимо проверить настройки существующего набора данных, который получает внешний объект.
    - **Ресурсы:** Проверить и скорректировать агрегатные функции для всех вычисляемых полей.
    - **Настройки структуры:** Добавить или скорректировать группировку по полям, идентифицирующим чек.
